---
output: 
    github_document:
      pandoc_args: --webtex
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# assessEpidemicCurves

<!-- badges: start -->
[![Travis build status](https://travis-ci.com/jpmeagher/assessEpidemicCurves.svg?branch=master)](https://travis-ci.com/jpmeagher/assessEpidemicCurves)
<!-- badges: end -->

The goal of assessEpidemicCurves is to model epidemic curves under heterogeneous disease reproduction, providing estimates for the time-varying reproduction number and assessing epidemic curves for evidence of superspreading. This package accompanies [Reference]

## Installation

You can install the development version of assessEpidemicCurves from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("jpmeagher/assessEpidemicCurves")
```

## Case Study: COVID-19 in the Republic of Ireland

```{r, message = FALSE}
library(assessEpidemicCurves)
library(rstan)
library(loo)
library(ggplot2)
library(dplyr)
library(magrittr)
library(lubridate)
library(EpiEstim)
library(knitr)
```


We consider the COVID-19 epidemic in the Republic of Ireland from March 1, 2020 to 28 February, 2021.

```{r, echo = FALSE, fig.height=3.5, fig.width=7}
ggplot(covid_incidence_roi_epidemiological_date) +
  geom_bar(
    aes(x = date, y =  count), stat = "identity",
    alpha = 0.5
  ) +
  theme_classic() +
  labs(
    title = "COVID-19 in the Republic of Ireland",
    x = "Epidimiological Date",
    y = "Reported Cases",
    color = NULL
  )
```

## The generative model for epidemic curves

Analyses are based on the hierarchical model for the daily incidence count of COVID-19 
$$
\begin{aligned}
p \left( y_t \mid \mu_t, \boldsymbol \eta_t, \boldsymbol \omega \right) &= \operatorname{Pois} \left( y_t \mid \mu_t + \sum_{s = 1}^t \omega_s \eta_{t-s} \right), \\
p \left( \eta_t \mid k, R_t \right) &= \operatorname{Gamma} \left( \eta_t \mid y_t k, \frac{k}{R_t}\right),
\end{aligned}
$$
where \(\boldsymbol y = \left(y_0, y_1, \dots, y_N \right)^\top\) is the epidemic curve seeded by \(y_0\), \(\boldsymbol \mu = \left(\mu_0, \mu_1, \dots, \mu_N \right)^\top\) is the rate at which cases are imported, \(\boldsymbol \omega = \left(\omega_1, \omega_2, \dots \right)^\top\) is the generation interval pmf, \(\boldsymbol \eta_t = \left( \eta_0, \eta_1, \dots, \eta_{t - 1} \right)\) is the disease momentum up to day \(t\), \(k\) is the case dispersion parameter and \(\boldsymbol R = \left(R_0, R_1, \dots, R_N \right)^\top\) are the cohort reproduction numbers.

This model is underpinned by a branching process model for secondary infections such that
$$
\begin{aligned}
p \left( z_{t, i} \mid \nu_{t_i} \right) &= \operatorname{Pois} \left( z_{t, i} \mid \nu_{t, i} \right), \\
p \left( \nu_{t, i} \mid k, R_t \right) &= \operatorname{Gamma} \left( k, \frac{k}{R_t}\right),
\end{aligned}
$$
where \(z_{t, i}\) is the number of secondary infections arising from the \(i^{th}\) index case on day \(t\) with an individual reproduction number \(\nu_{t, i}\). Within this model, \(\mathbb E \left[ z_{t, i}\right] = R_t\) and \(\operatorname{Var} \left( z_{t, i}\right) = R_t + R_t^2 / k \). This links to the model for \(y_t\) via
$$
\eta_t = \sum_{i = 1}^{y_t} \nu_{t, i}.
$$
Thus, the hierarchical model allows for heterogeneous disease reproduction resulting in over dispersed distributions of secondary infections, that is, superspreading may be a feature of the epidemic. Note that \(\lim_{k \to \infty} \operatorname{Var} \left( \nu_{t, i}\right) = 0\) and so this model admits homogeneous disease reproduction as a special case.

## Prior specification

In order to fit this generative model to data, we fix import rates \(\boldsymbol \mu = \left(\mu_0, \mu_1, \dots, \mu_N \right)^\top\), the generation interval pmf \(\boldsymbol \omega = \left(\omega_1, \omega_2, \dots \right)^\top\), and case dispersion parameter \(k\). We then propose a log-Gaussian process prior for \(\boldsymbol R\) such that
$$
\begin{aligned}
\log R_t &=  f \left( t \right), \\
f \left( t \right) &\sim \mathcal{GP} \left( 0, k \left(t, t' \right) \right), \\
k \left(t, t' \right) & = \alpha^2 \exp \left( - \frac{\left(t - t'\right)^2}{2 \ell^2}\right),
\end{aligned}
$$
where amplitude \(\alpha > 0\) and length-scale \(\ell > 0\) are specified a priori.

## Model fitting

The model described here can be computationally expensive to implement and so we only analyse only a subset of the data here. We examine reported COVID-19 cases from December 10, 2020, to January 31 2020, allowing the 5 days from December 5 to December 9 seed the epidemic. 

We assume that \(\mu_t = 1\) for all \(t\) and that \(\boldsymbol \omega\) is a discretised gamma distribution such that generation intervals have a mean of 5 days and standard deviation of 2.5 and are truncated at 21 days. The log-Gaussian process prior for \(\boldsymbol R\) is specified by \(\alpha = 1\) and \(\ell = 10\). We fit two models, \(\mathcal M_{0.1}\) where \(k = 0.1\) and \(\mathcal M_\infty\) where \(k \to \infty\).

We adjust the epidemic curve for day of the week effects by taking \(y_t\) to be the 7-day moving average of reported cases on day \(t\).

```{r}
df <- covid_incidence_roi_epidemiological_date %>% 
  mutate(ma_count = stats::filter(count, rep(1/7, 7)) %>% round) %>% 
  filter(date >= dmy(05122020) & date <= dmy(31012021)) 

D <- nrow(df)
# initialise heterogeneous disease reproduction
init_list <- lapply(
  1:4, function(i) {
    initialise_lgp_Rt(
      epidemic_curve = df$ma_count, 
      gp_amplitude = 1, k = 0.1
)
  } )
# fit heterogeneous disease reproduction
M_0.1 <- fit_Rt_lgp(
  epidemic_curve = df$ma_count, seed_days = 5,
  import_rate = rep(1, D), 
  generation_interval_mean = 5, generation_interval_sd = 2.5,
  generation_interval_length = 21,
  gp_amplitude = 1, gp_length_scale = 10,
  k = 0.1,
  cores = 4, refresh = 500, 
  init = init_list
)
# fit homogeneous disease reproduction
M_inf <- fit_Rt_lgp(
  epidemic_curve = df$ma_count, seed_days = 5,
  import_rate = rep(1, D), 
  generation_interval_mean = 5, generation_interval_sd = 2.5,
  generation_interval_length = 21,
  gp_amplitude = 1, gp_length_scale = 10,
  k = Inf,
  cores = 4, refresh = 500,
  control = list(max_treedepth = 15)
)

wt <- wallinga_teunis(
  incid = df$ma_count, 
  method = "parametric_si",
  config = list(
    t_start = (6:D),
    t_end = 6:D,
    mean_si = 5,
    std_si = 2.5,
    n_sim = 3
  )
)
```

Having fit the models to the epidemic curve we can explore the fitted posterior for \(\boldsymbol R\). Note that heterogeneous disease reproduction results in greater uncertainty on estimates for \(R_t\) on each day. We include Wallinga & Teunis' estimate available with the `EpiEstem` packagfe for comparison. All three estimate are in broad agreement up until the final days of the assessed epidemic curve.

```{r, fig.height=3.5, fig.width=7}
R_0.1 <- rstan::extract(M_0.1, "R") %>% 
  as.data.frame() %>% 
  magrittr::extract(sample.int(4000, 100), ) %>%
  t() %>% 
  unname() %>% 
  data.frame(date = df$date, R_0.1 = .) %>% 
  reshape2::melt(id = "date")

R_inf <- rstan::extract(M_inf, "R") %>% 
  as.data.frame() %>% 
  magrittr::extract(sample.int(4000, 100), ) %>%
  t() %>% 
  unname() %>% 
  data.frame(date = df$date, R_inf = .) %>% 
  reshape2::melt(id = "date") 

R <- rbind(
  cbind(R_0.1, model = "0.1"),
  cbind(R_inf, model = "inf")
) 

y_scalar <- 2.5
R %>%
  ggplot() +
  geom_bar(
    data = df,
    aes(x = date, y = y_scalar * ma_count /  max(df$ma_count) ), stat = "identity",
    alpha = 0.5
  ) +
  geom_line(aes(x = date, y = value, group = variable, color = model), alpha = 0.25) +
  geom_hline(yintercept = 1, lty = 3) +
  scale_color_viridis_d(labels = c("0.1", bquote(infinity))) +
  scale_y_continuous(
    bquote("R"["t"]),
    sec.axis = sec_axis(~ . * max(df$ma_count) / y_scalar, name = "7 Day Moving Average Incidence")
  ) +
  theme_classic() +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  geom_line(
    data = data.frame(
      date = df$date[6:D], R = wt$R$`Mean(R)`
    ),
    aes(x = date, y = R), lwd = 1.5
  ) +
  labs(
    title = "Fitted reproduction numbers",
    x = "Epidemiological Date",
    color = "k"
  )
```

## Model comparison

PSIS-LOO provides an easy to implement measure of model fit.

```{r}
loo_0.1 <- loo(M_0.1, moment_match = TRUE)
loo_inf <- loo(M_inf, moment_match = TRUE)

loo_compare(loo_0.1, loo_inf) %>% 
  kable(digits = 2, caption = "PSIS-LOO model selection favours $\\mathcal M_{0.1}$ (model1) over $\\mathcal M_{\\infty}$ (model2). This supports the conclusion that superspreading is a feature of the COVID-19 epidemic in the Republic of Ireland.")
  
```

This model comparison supports \(\mathcal M_{0.1}\) over \(\mathcal M_\infty\), indicating that superspreading is a feature of the COVID-19 epidemic in the Republic of Ireland and that estimates for \(\boldsymbol R\) offered by \(\mathcal M_{0.1}\) should be preferred.
